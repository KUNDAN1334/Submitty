{% import 'functions/Badge.twig' as Badge %}

{# If we have any reason to display this box. #}
{% if student_download == true or team_assignment == true or hide_test_details == false or core.getUser().accessGrading() %}
    <div class="content" {% if student_download == false and team_assignment == false and can_see_all_versions == false and not core.getUser().accessGrading() %}style="display: none;"{% endif %}>
        {% if team_assignment %}
            <h3>Team{% if team_name is not null %} ({{ team_name }}){% endif %}: {{ team_members }}</h3><br />
        {% endif %}

        {% if can_see_all_versions == true %}
            <div id="version-cont">
                <h3 class='label' id="submission_header">Select Submission Version:</h3>
                {% include 'grading/VersionChoice.twig' with({
                    'on_change': "versionChange('" ~ view_version_url ~ "', this)"
                }) %}

                {# If viewing the active version, show cancel button, otherwise so button to switch active #}
                {% if display_version > 0 %}
                    {% if display_version == active_version %}
                        <form method="post" action="{{ cancel_url }}">
                            <input type='hidden' name="csrf_token" value="{{ csrf_token }}" />
                            <input type="submit" id="do_not_grade" class="btn btn-default" value="Do Not Grade This Assignment">
                        </form>
                    {% else %}
                        <form method="post"
                              onsubmit='return checkVersionChange({{ display_version_days_late }},{{ allowed_late_days }})'
                              action="{{ change_version_url }}">
                            <input type='hidden' name="csrf_token" value="{{ csrf_token }}" />
                            <input type="submit" id="version_change" class="btn btn-primary" value="Grade This Version">
                        </form>
                    {% endif %}
                {% endif %}
            </div>

            {# /Switch version button #}

            {# disable changing submissions or cancelling assignment if student submit not allowed #}
            {% if not can_change_submissions %}
                <script>
                    $(function() {
                        $("#do_not_grade").prop("disabled", true);
                        $("#version_change").prop("disabled", true);
                    });
                </script>
            {% endif %}

            {# disable looking at other submissions if student any version not allowed #}
            {% if not can_see_all_versions %}
                <script>
                    $(function() {
                        $('select[name=submission_version]').hide();
                        $('#do_not_grade').hide();
                        $('#version_change').hide();
                        $('#submission_header').hide();
                        $('#submission_message').hide();
                    });
                </script>
            {% endif %}

            <div class="sub submission-message">
                Hello {{ ta_finished_grading_version is same as(false) ? "False1" : ta_finished_grading_version }} {{ ta_grading_in_progress_version is same as(false) ? "False2":ta_grading_in_progress_version }} {{ active_same_as_graded == true ? "True" : "False"}}<br>
                Hello {{ active_same_as_graded is same as(true) ? "True": "False" }} {{ display_same_as_graded is same as(true) ? "True": "False" }}<br>
                Hello {{ after_ta_open }} {{ has_manual_grading }}
                {# If they have no active version #}
                {% if active_version == 0 and display_version == 0 %}
                    <p class="red-message">
                        Note: You have selected to NOT GRADE THIS ASSIGNMENT.<br />
                        This assignment will not be graded 
                        {% if has_manual_grading %}
                            by the instructor/TAs 
                        {% endif %}
                        and a zero will be recorded in the gradebook.<br />
                        You may select any version above and press "Grade This Version" to re-activate your submission for grading.<br />
                    </p>
                
                {# Grades are released and incomplete #}
                {% elseif ta_grades_incomplete %}
                    <p class="red-message">
                        Note: Grades have been released for this assignment but your assignment was not graded.<br />
                        Contact an instructor or TA if this is unexpected.
                    </p>
                
                {# No active version but looking at a valid version #}
                {% elseif active_version == 0 %}
                    <p class="red-message">
                        Note: You have selected to NOT GRADE THIS ASSIGNMENT.<br />
                        This assignment will not be graded
                        {% if has_manual_grading %}
                            by the instructor/TAs 
                        {% endif %}
                        and a zero will be recorded in the gradebook.<br />
                        Click the button "Grade This Version" if you would like to specify that this version of your homework should be graded.
                    </p>
                
                {# TA Grading opened and either active or display differs from what is graded #}
                {% elseif has_manual_grading and after_ta_open and ( not active_same_as_graded or display_version != active_version ) %}
                    <p class="red-message">
                        Note: TA Grading has 
                        {% if not display_same_as_graded %}
                            {% if ta_finished_grading_version %}
                                finished on Version #{{ ta_finished_grading_version }}.
                            {% elseif ta_grading_in_progress_version %}
                                started on Version #{{ ta_grading_in_progress_version }}.
                            {# Multiple version conflicts #}
                            {% else %}
                                started.
                            {% endif %}
                        {% else %}
                            {% if ta_finished_grading_version %}
                                finished on this version.
                            {% elseif ta_grading_in_progress_version %}
                                started on this version.
                            {% else %} 
                                started.
                            {% endif %}
                        {% endif %}
                        <br />
                        {% if display_version != active_version %}
                            Clicking the button "Grade This Version" would change the active version to this version.<br />
                        {% endif %}
                        If the active version does not match your graded version, a zero will be recorded in the gradebook.<br />
                    </p>
                {# Valid submission #}
                {% elseif active_version > 0 and active_version == display_version %}
                    <p class="green-message">
                        Note: This version of your assignment will be graded 
                        {% if has_manual_grading %}
                            by the instructor/TAs 
                        {% endif %}
                        and the score recorded in the gradebook.
                    </p>
                {% elseif active_version > 0 and active_version != display_version %}
                    <p class="green-message">
                        Note: Click "Grade This Version" if you would like this version to be graded
                        {% if has_manual_grading %}
                            by the instructor/TAs
                        {% endif %}
                        .
                    </p>
                {% endif %}
            </div>
        {% endif %}
        {% if (failed_file != '' or (file_count == 0 and not incomplete_autograding)) and is_vcs %}
        <div id="error-message" class="red-message">
            <b>Warning: The submitted repository is empty.</b><br/>
            {% if failed_file != '' %}
                <b>{{ failed_file|nl2br }}</b>
            {% else %}
                If you have made changes to your repository, make sure you commit and push them.
            {% endif %}
        </div>
        {% endif %}
        {% if active_version != 0 or display_version != 0 %}
            {% include 'submission/homework/CurrentVersionResults.twig' %}
        {% endif %}
    </div>
{% endif %}
